# ========== DETECTION SCREEN - FINAL VERSION ==========
elif st.session_state.page == "detect":
    
    # ==============================
    # DISEASE INFORMATION DATABASE
    # ==============================
    DISEASE_INFO = {
        # Leaf Smut
        "Leaf Smut": {
            "description": "A fungal disease causing small black spots on leaves, reducing photosynthesis and plant vigor.",
            "severity": "Moderate", "severity_color": "#ff9800"
        },
        "00 Leaf Smut": {
            "description": "A fungal disease causing small black spots on leaves, reducing photosynthesis and plant vigor.",
            "severity": "Moderate", "severity_color": "#ff9800"
        },

        # Leaf Scald
        "Leaf Scald": {
            "description": "Creates large lesions with white and brown bands, severely impacting leaf function and reducing yield.",
            "severity": "High", "severity_color": "#f44336"
        },
        "00 Leaf Scald": {
            "description": "Creates large lesions with white and brown bands, severely impacting leaf function and reducing yield.",
            "severity": "High", "severity_color": "#f44336"
        },

        # Narrow Brown Leaf Spot
        "Narrow Brown Leaf Spot": {
            "description": "Narrow brown lesions on leaves that can reduce grain quality and yield significantly.",
            "severity": "Moderate", "severity_color": "#ff9800"
        },
        "00 Narrow Brown Leaf Spot": {
            "description": "Narrow brown lesions on leaves that can reduce grain quality and yield significantly.",
            "severity": "Moderate", "severity_color": "#ff9800"
        },

        # Rice Blast
        "Rice Blast": {
            "description": "One of the most destructive rice diseases with diamond-shaped lesions. Can reduce yield by up to 50%.",
            "severity": "High", "severity_color": "#f44336"
        },
        "00 Rice Blast": {
            "description": "One of the most destructive rice diseases with diamond-shaped lesions. Can reduce yield by up to 50%.",
            "severity": "High", "severity_color": "#f44336"
        },

        # Rice Stripes
        "Rice Stripes": {
            "description": "A viral disease causing yellow to white stripes on leaves, transmitted by planthoppers and causing stunted growth.",
            "severity": "High", "severity_color": "#f44336"
        },
        "00 Rice Stripes": {
            "description": "A viral disease causing yellow to white stripes on leaves, transmitted by planthoppers and causing stunted growth.",
            "severity": "High", "severity_color": "#f44336"
        },

        # Rice Tungro
        "Rice Tungro": {
            "description": "A viral complex causing yellow-orange discoloration and stunting. Can cause total crop failure if not managed early.",
            "severity": "High", "severity_color": "#f44336"
        },
        "00 Rice Tungro": {
            "description": "A viral complex causing yellow-orange discoloration and stunting. Can cause total crop failure if not managed early.",
            "severity": "High", "severity_color": "#f44336"
        },

        # Brown Spot
        "Brown Spot": {
            "description": "Brown spot disease causes circular brown lesions on leaves, reducing photosynthetic area and grain quality.",
            "severity": "Moderate", "severity_color": "#ff9800"
        },
        "00 Brown Spot": {
            "description": "Brown spot disease causes circular brown lesions on leaves, reducing photosynthetic area and grain quality.",
            "severity": "Moderate", "severity_color": "#ff9800"
        },

        # Rice Hispa
        "Rice Hispa": {
            "description": "Rice Hispa is an insect pest that scrapes chlorophyll from the leaf surface, leaving white streaks that reduce photosynthesis.",
            "severity": "Moderate", "severity_color": "#ff9800"
        },
        "00 Rice Hispa": {
            "description": "Rice Hispa is an insect pest that scrapes chlorophyll from the leaf surface, leaving white streaks that reduce photosynthesis.",
            "severity": "Moderate", "severity_color": "#ff9800"
        },
        "Rich Hispa": {
            "description": "Rice Hispa is an insect pest that scrapes chlorophyll from the leaf surface, leaving white streaks that reduce photosynthesis.",
            "severity": "Moderate", "severity_color": "#ff9800"
        },

        # Healthy Rice
        "Healthy Rice": {
            "description": "No disease detected. Your rice plant appears healthy with no visible signs of infection.",
            "severity": "None", "severity_color": "#4CAF50"
        },
        "00 Healthy Rice": {
            "description": "No disease detected. Your rice plant appears healthy with no visible signs of infection.",
            "severity": "None", "severity_color": "#4CAF50"
        },

        # Non Plant Object
        "Non Plant Object": {
            "description": "Please retake or upload again because this image is not a rice plant image.",
            "severity": "N/A", "severity_color": "#9e9e9e", "is_non_plant": True
        },
        "00 Non Plant Object": {
            "description": "Please retake or upload again because this image is not a rice plant image.",
            "severity": "N/A", "severity_color": "#9e9e9e", "is_non_plant": True
        },

        # Bacterial Leaf Blight
        "Bacterial Leaf Blight": {
            "description": "A bacterial disease causing water-soaked lesions that turn yellow to white. Can cause severe yield loss in tropical areas.",
            "severity": "High", "severity_color": "#f44336"
        },
        "00 Bacterial Leaf Blight": {
            "description": "A bacterial disease causing water-soaked lesions that turn yellow to white. Can cause severe yield loss in tropical areas.",
            "severity": "High", "severity_color": "#f44336"
        },

        # Sheath / Shealth Blight
        "Sheath Blight": {
            "description": "A fungal disease causing irregular lesions on leaf sheaths, leading to lodging and yield reduction.",
            "severity": "Moderate", "severity_color": "#ff9800"
        },
        "Shealth Blight": {
            "description": "A fungal disease causing irregular lesions on leaf sheaths, leading to lodging and yield reduction.",
            "severity": "Moderate", "severity_color": "#ff9800"
        },
        "00 Sheath Blight": {
            "description": "A fungal disease causing irregular lesions on leaf sheaths, leading to lodging and yield reduction.",
            "severity": "Moderate", "severity_color": "#ff9800"
        },
        "00 Shealth Blight": {
            "description": "A fungal disease causing irregular lesions on leaf sheaths, leading to lodging and yield reduction.",
            "severity": "Moderate", "severity_color": "#ff9800"
        }
    }

    # ==============================
    # NORMALIZATION FUNCTION
    # ==============================
    def normalize_disease_name(name):
        """Normalize prediction class names to match DISEASE_INFO keys."""
        name = name.strip().replace("00 ", "").replace("00", "").title()
        if "Hispa" in name:
            return "Rice Hispa"
        if "Healthy" in name:
            return "Healthy Rice"
        if "Shealth" in name:
            return "Sheath Blight"
        if "Brownspot" in name:
            return "Brown Spot"
        return name

    # ==============================
    # PAGE UI STYLING
    # ==============================
    st.markdown("""
        <style>
            .stApp { background: linear-gradient(135deg, #e8f5e9 0%, #ffffff 100%) !important; }
            .upload-section {
                background-color: #f8f9fa; border: 2px dashed #4CAF50; border-radius: 15px;
                padding: 30px; text-align: center; margin: 20px 0;
            }
            .upload-text { color: #2e7d32; font-size: 18px; font-weight: 600; }
            .upload-subtext { color: #6c757d; font-size: 14px; margin-bottom: 20px; }
            .preview-image {
                border-radius: 12px; border: 3px solid #4CAF50;
                box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            }
            .result-box {
                background: #ffffff; padding: 20px; border-radius: 12px;
                margin: 20px 0; border-left: 5px solid #4CAF50;
                box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            }
            .disease-result { border-left: 4px solid #ff5722 !important; }
            .confidence-bar { height: 8px; background: #e0e0e0; border-radius: 10px; margin: 10px 0; }
            .confidence-fill {
                height: 100%; background: linear-gradient(90deg, #ff5722, #4CAF50); border-radius: 10px;
            }
            .severity-badge {
                display: inline-block; padding: 4px 12px; border-radius: 12px;
                font-size: 12px; font-weight: 600; color: white; margin: 8px 0;
            }
            .description-text {
                color: #555; font-size: 15px; line-height: 1.7;
                margin: 10px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;
            }
        </style>
    """, unsafe_allow_html=True)

    # ==============================
    # PAGE CONTENT
    # ==============================
    st.markdown("""
    <div style='text-align: center; margin-bottom: 20px;'>
        <h2 style='color: #2e7d32;'>Disease Detection</h2>
        <p style='color: #6c757d;'>Upload rice leaf image for analysis</p>
    </div>
    """, unsafe_allow_html=True)

    # Initialize session state
    if 'preview_image' not in st.session_state:
        st.session_state.preview_image = None

    # Upload or capture
    uploaded_file = st.file_uploader("Choose an image", type=["jpg", "jpeg", "png"], key="file_upload")
    if uploaded_file and st.session_state.preview_image != uploaded_file:
        st.session_state.preview_image = uploaded_file
        st.rerun()

    if st.session_state.preview_image is None:
        st.markdown("<div style='margin: 15px 0;'></div>", unsafe_allow_html=True)
        camera_photo = st.camera_input("Take a picture", key="camera_input")
        if camera_photo:
            st.session_state.preview_image = camera_photo
            st.rerun()

    # ==============================
    # IMAGE PREVIEW
    # ==============================
    if st.session_state.preview_image:
        image = Image.open(st.session_state.preview_image)
        buffered = io.BytesIO()
        image.save(buffered, format="PNG")
        img_str = base64.b64encode(buffered.getvalue()).decode()

        st.markdown(f"""
        <div class="upload-section">
            <img src="https://cdn-icons-png.flaticon.com/128/2659/2659360.png" width="50" style="margin-bottom: 15px;">
            <div class="upload-text">Image Preview</div>
            <div class="upload-subtext">Ready for analysis</div>
            <img src="data:image/png;base64,{img_str}" class="preview-image" width="300">
        </div>
        """, unsafe_allow_html=True)

        if st.button("✕ Clear Image", key="clear_btn", use_container_width=True):
            st.session_state.preview_image = None
            st.session_state.pop('file_upload', None)
            st.session_state.pop('camera_input', None)
            st.rerun()
    else:
        st.markdown("""
        <div class="upload-section">
            <img src="https://cdn-icons-png.flaticon.com/128/1829/1829589.png" width="60" style="margin-bottom: 15px;">
            <div class="upload-text">Upload Rice Leaf Image</div>
            <div class="upload-subtext">Browse files or take a photo to get started</div>
        </div>
        """, unsafe_allow_html=True)

    # ==============================
    # DETECTION PROCESS
    # ==============================
    if st.button("DETECT DISEASE", key="detect_btn", use_container_width=True, type="primary"):
        if not st.session_state.preview_image:
            st.error("Please upload an image or take a photo first.")
        else:
            with st.spinner("Analyzing image..."):
                try:
                    import tempfile
                    with tempfile.NamedTemporaryFile(delete=False, suffix=".jpg") as tmp_file:
                        image.save(tmp_file, format="JPEG")
                        tmp_file_path = tmp_file.name

                    client = init_client()
                    result = client.infer(tmp_file_path, model_id="palayprotector-ver-2-gmeok/1")

                    if result.get("predictions"):
                        prediction = result["predictions"][0]
                        disease = prediction["class"]
                        confidence = prediction["confidence"] * 100
                        normalized_name = normalize_disease_name(disease)

                        if normalized_name in DISEASE_INFO:
                            disease_data = DISEASE_INFO[normalized_name]

                            # Handle Non-Plant
                            if disease_data.get('is_non_plant', False):
                                st.markdown(f"""
                                <div class='result-box' style='border-left: 4px solid #9e9e9e;'>
                                    <h2 style="margin: 0 0 15px 0; color: #757575;">⚠️ {normalized_name}</h2>
                                    <div style="text-align: center; padding: 20px;">
                                        <img src="https://cdn-icons-png.flaticon.com/128/4076/4076549.png" width="60">
                                        <div class="description-text" style="margin-top: 20px;">
                                            <strong>Notice:</strong><br>{disease_data['description']}
                                        </div>
                                    </div>
                                </div>
                                """, unsafe_allow_html=True)

                            # Handle Healthy
                            elif "Healthy" in normalized_name:
                                st.markdown(f"""
                                <div class='result-box'>
                                    <h2 style="margin: 0 0 15px 0; color: #2e7d32;">Detection Result</h2>
                                    <div style="text-align: center; padding: 20px;">
                                        <img src="https://cdn-icons-png.flaticon.com/128/5610/5610944.png" width="60">
                                        <h2 style="color: #2e7d32; font-size: 28px; margin: 15px 0;">Healthy Rice Plant</h2>
                                        <span style="font-weight: bold; color: #2e7d32; font-size: 20px;">{confidence:.1f}% Confidence</span>
                                        <div class="description-text">
                                            <strong>About this plant:</strong><br>{disease_data['description']}
                                        </div>
                                    </div>
                                </div>
                                """, unsafe_allow_html=True)

                            # Handle Diseased
                            else:
                                st.markdown(f"""
                                <div class='result-box disease-result'>
                                    <h2 style="margin: 0 0 15px 0; color: #2e7d32;">Detection Result</h2>
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                        <span style="font-weight: bold; color: #d32f2f; font-size: 28px;">{normalized_name}</span>
                                        <span style="font-weight: bold; color: #2e7d32; font-size: 24px;">{confidence:.1f}%</span>
                                    </div>
                                    <span class="severity-badge" style="background-color: {disease_data['severity_color']};">
                                        Severity: {disease_data['severity']}
                                    </span>
                                    <div class="confidence-bar">
                                        <div class="confidence-fill" style="width: {confidence}%;"></div>
                                    </div>
                                    <div class="description-text">
                                        <strong>About this disease:</strong><br>{disease_data['description']}
                                    </div>
                                </div>
                                """, unsafe_allow_html=True)

                            # Save history
                            if not disease_data.get('is_non_plant', False):
                                conn = sqlite3.connect("users.db")
                                cursor = conn.cursor()
                                cursor.execute("""
                                    INSERT INTO history (user_id, result, confidence)
                                    VALUES (?, ?, ?)
                                """, (st.session_state.user_id, normalized_name, confidence))
                                conn.commit()
                                conn.close()

                        # Unknown Disease
                        else:
                            st.markdown(f"""
                            <div class='result-box disease-result'>
                                <h2 style="margin: 0 0 15px 0; color: #2e7d32;">Detection Result</h2>
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                    <span style="font-weight: bold; color: #d32f2f; font-size: 28px;">{normalized_name}</span>
                                    <span style="font-weight: bold; color: #2e7d32; font-size: 24px;">{confidence:.1f}%</span>
                                </div>
                                <span class="severity-badge" style="background-color: #ff9800;">Status: Unknown Disease</span>
                                <div class="confidence-bar"><div class="confidence-fill" style="width: {confidence}%;"></div></div>
                                <div class="description-text">
                                    <strong>About this disease:</strong><br>
                                    This disease type is not yet in our database. Please consult with agricultural experts for proper diagnosis and treatment.
                                </div>
                            </div>
                            """, unsafe_allow_html=True)

                    else:
                        st.error("No predictions returned from the model.")
                except Exception as e:
                    st.error(f"Error during detection: {str(e)}")

    # ==============================
    # BACK BUTTON
    # ==============================
    st.markdown("<br>", unsafe_allow_html=True)
    if st.button("← Back to Home", key="back_home", use_container_width=True):
        st.session_state.page = "home"
        st.session_state.preview_image = None
        st.rerun()
